<!doctype html>
<html lang="el">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Store311 Attendance</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">
<style>
:root { --pad:22px; --blue:#3b82f6; --blue-border:#1d4ed8; --green:#d9fbe4; --green-border:#b8f0c8; }

/* ÎŠÎ´Î¹Î¿ ÏÏˆÎ¿Ï‚ iOS/Android */
html, body { height:-webkit-fill-available; }
html, body {
width:100%; margin:0; overflow:hidden; background:#fff; color:#111;
font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;
}

.viewport {
box-sizing:border-box;
height:100dvh; width:100vw;
padding:10px 20px 20px;
display:flex; flex-direction:column; gap:14px;
}

/* --- LOGO --- */
.brand {
display:flex; flex-direction:column; align-items:center; gap:8px; margin-top:6px;
}
.brand img {
display:block;
width: clamp(120px, 18vw, 160px);
height:auto;
margin:6px auto 10px;
image-rendering:auto;
-webkit-user-drag:none;
}
.brand .title { font-weight:800; font-size:26px; }
.brand .subtitle { color:#444; margin-top:2px; }

.toprow{ display:flex; justify-content:flex-end; gap:10px; }
.lockbtn{ border:1px solid #d7dbe2; background:#fff; padding:8px 10px; border-radius:10px; cursor:pointer; font-size:14px; }

.tabbar{ display:flex; gap:14px; justify-content:center; flex-wrap:wrap; }
.tabbar button{ padding:10px 14px; border-radius:14px; border:1px solid #ddd; background:#f6f7fb; cursor:pointer; }
.tabbar button.active{ background:#dfe2e8; border-color:#cfd4dc; }
.tabbar .guard::after{ content:" ğŸ”’"; font-size:12px; opacity:.7; }

.content{ flex:1; display:flex; flex-direction:column; gap:14px; overflow:hidden; }
.tab{ display:none; flex:1; overflow:auto; -webkit-overflow-scrolling:touch; }
.tab.active{ display:block; }

.card{ background:#fff; padding:14px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.06); }
label{ display:block; margin:8px 0 6px; font-size:14px; color:#333; }
input,select,button,textarea{ font-size:16px; padding:12px; border-radius:10px; border:1px solid #d7dbe2; outline:none; }
textarea{ resize:vertical; }
.row{ display:flex; gap:10px; flex-wrap:wrap; }
.grow{ flex:1; }

.controls {
display: flex;
gap: 28px;
flex-wrap: wrap;
justify-content: center;
margin-top: 14px;
}
.bigbtn {
flex: 1;
min-height: 140px;
font-size: 32px;
font-weight: 900;
border-radius: 24px;
transition: all 0.15s ease;
box-shadow: 0 6px 14px rgba(0,0,0,0.1);
}
.in {
background: linear-gradient(180deg,#d7fbe4 0%,#b6efc8 100%);
border: 2px solid #9ce3b4;
color: #064e3b;
}
.out {
background: linear-gradient(180deg,#3b82f6 0%,#1d4ed8 100%);
border: 2px solid #1e3a8a;
color: #fff;
}
.in:active, .out:active {
transform: scale(0.97);
box-shadow: 0 3px 8px rgba(0,0,0,0.25) inset;
filter: brightness(0.95);
}
@media (max-width:520px){ .bigbtn{ flex-basis:100%; } }

table{ width:100%; border-collapse:collapse; margin-top:12px; font-size:14px; }
th,td{ padding:8px; border-bottom:1px solid #eee; text-align:left; }

.hint{ color:#666; font-size:13px; margin-top:6px; }
.status{ margin-top:8px; font-size:14px; }
footer{ color:#666; font-size:12px; text-align:center; padding:8px 0; }

/* Modal PIN */
#pinModal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); align-items:center; justify-content:center; }
#pinBox{ background:#fff; padding:18px; border-radius:12px; width:320px; box-shadow:0 10px 30px rgba(0,0,0,.2); }
#pinBox h3{ margin:0 0 8px 0; font-size:18px; }
#pinMsg{ color:#b42318; font-size:13px; margin-top:8px; }
</style>
</head>

<body>
<div class="viewport">
<div class="brand">
<img id="logo" src="logo.png?v=7" alt="Store311 logo">
<div class="title">Store311 Attendance</div>
<div class="subtitle">Î£ÏÏƒÏ„Î·Î¼Î± Ï€Î±ÏÎ¿Ï…ÏƒÎ¹ÏÎ½ Ï€ÏÎ¿ÏƒÏ‰Ï€Î¹ÎºÎ¿Ï</div>
</div>

<div class="toprow">
<button class="lockbtn" id="lockBtn">ÎšÎ»ÎµÎ¯Î´Ï‰Î¼Î±</button>
</div>

<div class="tabbar">
<button class="tabbtn active" data-tab="punch">Î§Ï„ÏÏ€Î·Î¼Î±</button>
<button class="tabbtn guard" data-tab="history">Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ</button>
<button class="tabbtn guard" data-tab="reports">Î‘Î½Î±Ï†Î¿ÏÎ­Ï‚</button>
<button class="tabbtn guard" data-tab="settings">Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚</button>
</div>

<div class="content">
<div class="card tab active" id="tab-punch">
<div class="row">
<div class="grow">
<label>Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÎµÏÎ³Î±Î¶ÏŒÎ¼ÎµÎ½Î¿ / Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·</label>
<div class="row">
<select id="employee" class="grow"></select>
<input id="newname" placeholder="ÎÎ­Î¿ ÏŒÎ½Î¿Î¼Î±">
<button id="add" class="small">Î ÏÏŒÏƒÎ¸ÎµÏƒÎµ</button>
</div>
<div class="hint">ÎšÎ±Ï„Î±Ï‡ÏÏÎ¹ÏƒÎ· IN/OUT â€” Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· offline & Î±Ï€Î¿ÏƒÏ„Î¿Î»Î® ÏƒÏ„Î¿ cloud.</div>
</div>
<div>
<label for="note">Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·</label>
<input id="note" placeholder="Ï€.Ï‡. ÎºÎ±Î¸Ï…ÏƒÏ„Î­ÏÎ·ÏƒÎ· ÎœÎœÎœ">
</div>
</div>

<div style="margin-top:10px">
<label>Î§Ï„ÏÏ€Î·Î¼Î± ÎºÎ¬ÏÏ„Î±Ï‚</label>
<div class="controls">
<button id="punchIn" class="bigbtn in">âœ“ INâ€“Î•Î¯ÏƒÎ¿Î´Î¿Ï‚</button>
<button id="punchOut" class="bigbtn out">â—¼ï¸ OUT â€” Î‘Ï€Î¿Ï‡ÏÏÎ·ÏƒÎ·</button>
</div>
<div id="statusRow" class="status">â€”</div>
<div id="lastRow" class="hint">Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿ Ï‡Ï„ÏÏ€Î·Î¼Î±: â€”</div>
</div>
</div>

<div class="card tab" id="tab-history">
<div class="row" style="justify-content:space-between;align-items:center">
<div class="grow"><label>Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ (Ï€Î¹Î¿ Ï€ÏÏŒÏƒÏ†Î±Ï„Î± Ï€ÏÏÏ„Î±)</label></div>
<div class="row">
<input id="search" placeholder="Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Î¿Î½ÏŒÎ¼Î±Ï„Î¿Ï‚/Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±Ï‚">
<button id="exportBtn" class="small">CSV</button>
<button id="downloadJson" class="small">JSON</button>
<button id="clear" class="small">ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎ¼Î±</button>
</div>
</div>
<table id="logTable">
<thead><tr><th>ÎŒÎ½Î¿Î¼Î±</th><th>Î•Î½Î­ÏÎ³ÎµÎ¹Î±</th><th>Î—Î¼/Î½Î¯Î±</th><th>ÎÏÎ±</th><th>Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚</th></tr></thead>
<tbody></tbody>
</table>
</div>

<div class="card tab" id="tab-reports">
<div class="row">
<div><label>ÎœÎ®Î½Î±Ï‚</label><input id="rep-month" type="month"></div>
<div><label>&nbsp;</label><button id="calc-month" class="small">Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚</button></div>
</div>
<table id="reportTable">
<thead><tr><th>Î•ÏÎ³Î±Î¶ÏŒÎ¼ÎµÎ½Î¿Ï‚</th><th>Î—Î¼Î­ÏÎ±</th><th>Î—Î¼/Î½Î¯Î±</th><th>ÎÏÎµÏ‚</th><th>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</th></tr></thead>
<tbody></tbody>
</table>
</div>

<div class="card tab" id="tab-settings">
<label>Î›Î¯ÏƒÏ„Î± ÎµÏÎ³Î±Î¶Î¿Î¼Î­Î½Ï‰Î½</label>
<textarea id="names" rows="4" style="width:100%;font-family:inherit" placeholder="ÎšÎ¬Î¸Îµ ÏŒÎ½Î¿Î¼Î± ÏƒÎµ Î½Î­Î± Î³ÏÎ±Î¼Î¼Î®"></textarea>
<div class="row">
<div class="grow">
<label>Webhook URL (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ â€” Î±Î½ Ï„Î¿ Î±Ï†Î®ÏƒÎµÎ¹Ï‚ ÎºÎµÎ½ÏŒ, Î¸Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Ï„Î¿ Ï€ÏÎ¿ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿)</label>
<input id="webhook" placeholder="ÎµÏ€Î¹ÎºÏŒÎ»Î»Î·ÏƒÎµ ÎµÎ´Ï Î¬Î»Î»Î¿ Web App URL Î±Î½ Î¸Î­Î»ÎµÎ¹Ï‚">
<div class="hint">Î£Ï„Î¿ OUT ÏƒÏ„Î­Î»Î½ÎµÏ„Î±Î¹ payload (start/end/minutes/date/note/type).</div>
</div>
<div><label>ÎÏÎ± Î­Î½Î±ÏÎ¾Î·Ï‚</label><input id="shiftStart" placeholder="08:00"></div>
<div><label>Î‘Î½Î¿Ï‡Î® ÎºÎ±Î¸Ï…ÏƒÏ„Î­ÏÎ·ÏƒÎ·Ï‚</label><input id="grace" type="number" min="0" step="1" value="5"></div>
</div>
<div class="row">
<button id="saveSettings">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
<span class="hint" id="saveMsg"></span>
</div>
</div>
</div>

<footer>PWA offline â€¢ Cloud sync ÏƒÏ„Î¿ OUT â€¢ PIN-lock</footer>
</div>

<!-- Modal PIN -->
<div id="pinModal">
<div id="pinBox">
<h3 id="pinTitle">ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î®</h3>
<input id="pinInput" type="password" placeholder="PIN" style="width:100%; padding:10px; border:1px solid #d7dbe2; border-radius:10px">
<div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end">
<button id="pinCancel" class="small">Î†ÎºÏ…ÏÎ¿</button>
<button id="pinOk" class="small">OK</button>
</div>
<div id="pinMsg"></div>
</div>
</div>

<script>
/* ===== DEFAULT CLOUD SETTINGS (Î”Î•Î Ï‡Î¬Î½Î¿Î½Ï„Î±Î¹ Ï€Î¿Ï„Î­) ===== */

/* Î’Î‘Î›Î• Î•Î”Î© Î¤ÎŸ Î”Î™ÎšÎŸ Î£ÎŸÎ¥ EXEC URL Î¤ÎŸÎ¥ Apps Script (ÎŸÎ§Î™ /dev, ÎœÎŸÎÎŸ /exec) */
const DEFAULT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyBgRm0DuvbHKfuqWzqNJo0Bv9YfbCwc2N1nJr7X67wuQDXLOTdSjwehTGriXjEWEWVFg/exec";

/* ÎœÏŒÎ½Î¹Î¼Î· Î»Î¯ÏƒÏ„Î± ÎµÏÎ³Î±Î¶Î¿Î¼Î­Î½Ï‰Î½ (fallback Î±Î½ Ï‡Î±Î¸ÎµÎ¯ Ï„Î¿ localStorage) */
const DEFAULT_NAMES = [
"Î“Î¡Î™Î’Î‘ Î’Î‘Î£Î™Î›Î™ÎšÎ—",
"Î¤ÎŸÎ¡Î™ Î™Î©Î‘ÎÎÎ‘",
"ÎÎ¤ÎŸÎ¥ÎÎ— Î”Î—ÎœÎ—Î¤Î¡Î‘",
"Î“Î™Î‘ÎÎÎ‘ÎšÎŸÎ ÎŸÎ¥Î›ÎŸÎ£ Î”Î—ÎœÎ—Î¤Î¡Î—Î£",
"ÎœÎ¥Î£Î¤Î•ÎšÎ™Î‘ Î•ÎœÎœÎ‘ÎÎŸÎ¥Î•Î›",
"Î”Î™Î‘ÎœÎ‘ÎÎ¤ÎŸÎ ÎŸÎ¥Î›ÎŸÎ£ Î“Î™Î©Î¡Î“ÎŸÎ£",
"Î§Î‘Î¡Î™ÎÎŸÎ£ ÎÎ™ÎšÎŸÎ£",
"BERISHA DANIEL",
"ÎšÎ‘ÎÎ‘ÎšÎ‘ÎšÎ—Î£ Î“Î™Î‘ÎÎÎ—Î£",
"ÎšÎ›Î™ÎÎ¤Î™ÎŸÎÎ‘ Î‘Î“Î“Î•Î›Î™ÎšÎ—",
"TOYFAILI MARIE",
"Î¤Î¡Î‘Î™Î‘ÎÎŸÎ£ Î‘Î›Î•ÎÎ‘ÎÎ”Î¡ÎŸÎ£",
"Î Î‘Î Î‘ÎÎ¤Î©ÎÎ—Î£ Î“Î™Î©Î¡Î“ÎŸÎ£",
"Î£Î‘ÎœÎ¨Î©Î Î‘Î˜Î—ÎÎ‘",
"ÎšÎ‘Î¡Î’Î•Î›Î— Î‘Î›Î•ÎÎ‘ÎÎ”Î¡Î‘",
"ÎšÎŸÎ–Î‘ÎÎ™Î”Î—Î£ Î Î‘Î¡Î—Î£",
"Î”Î¡ÎŸÎ¥Î”Î‘ÎšÎ—Î£ Î‘ÎÎ¤Î©ÎÎ—Î£",
"Î£Î¤Î‘Î¥Î¡ÎŸÎ¥Î›Î‘ÎšÎ— Î¦Î©Î¤Î•Î™ÎÎ—",
"Î Î‘Î¡Î‘Î£Î¥Î¡Î— Î‘Î¡Î“Î¥Î¡Î©",
"Î”Î™Î‘ÎšÎŸÎ¥ÎœÎ— ÎœÎ‘Î¡Î™ÎÎ‘",
"ÎšÎ‘Î¤Î£Î‘Î›Î—Î£ Î£Î¤Î‘Î¥Î¡ÎŸÎ£",
"Î Î‘Î Î‘Î”Î‘ÎšÎ—Î£ ÎšÎ©Î£Î¤Î‘Î£",
"Î˜Î•ÎŸÎ”Î©Î¡Î‘ÎšÎ—Î£ Î Î‘ÎÎ‘Î“Î™Î©Î¤Î—Î£",
"Î”Î™Î‘ÎšÎ‘ÎšÎ— ÎšÎ‘Î¤Î•Î¡Î™ÎÎ‘",
"Î“Î•Î©Î¡Î“Î™Î¤Î£Î—Î£ Î‘ÎÎ¤Î¡Î•Î‘Î£",
"Î£Î¤Î‘ÎœÎ‘Î¤Î‘ÎšÎ— Î£Î¤Î•Î›Î›Î‘",
"ÎšÎ‘Î¡Î¤Î‘Î›Î—Î£ Î£Î¤Î‘Î¥Î¡ÎŸÎ£",
"ÎœÎŸÎ¥ÎœÎŸÎ¥Î¡Î—Î£ Î‘Î›Î•ÎÎ‘ÎÎ”Î¡ÎŸÎ£",
"ÎšÎ¥Î¡Î™Î‘ÎšÎŸÎ¥Î›Î—Î£ Î Î•Î¤Î¡ÎŸÎ£",
"ÎšÎŸÎ¥Î¡Î™Î”Î‘ÎšÎ—Î£ ÎšÎ©Î£Î¤Î‘Î£",
"ÎšÎ›Î‘Î”ÎŸÎ£ Î‘ÎÎ¤Î©ÎÎ—Î£",
"Î Î‘Î Î‘Î”ÎŸÎÎ™ÎšÎŸÎ›Î‘ÎšÎ—Î£ Î“Î™Î‘ÎÎÎ—Î£",
"ÎšÎŸÎ¥ÎÎ”ÎŸÎ¥Î¡Î‘ÎšÎ—Î£ ÎšÎ¥Î¡Î™Î‘ÎšÎŸÎ£",
"ÎšÎ©ÎÎ£Î¤Î‘ÎÎ¤ÎŸÎ ÎŸÎ¥Î›ÎŸÎ£ Î‘ÎÎ‘Î£Î¤Î‘Î£Î—Î£"
];

const SECRET_TOKEN = "store311_2025_secure_token_93hfuWvL8p7Zt!xA"; // Î¯Î´Î¹Î¿ Î¼Îµ Apps Script
</script>

<script>
/* ====== Storage helpers ====== */
const EMP_KEY='att_employees_v2', LOG_KEY='att_log_v2', SET_KEY='att_settings_v2', ADMIN_KEY='store311_admin_hash';
const $=(s,p=document)=>p.querySelector(s);
const $$=(s,p=document)=>Array.from(p.querySelectorAll(s));
const load=(k,d)=>{try{const r=localStorage.getItem(k);return r?JSON.parse(r):d}catch{return d}}
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const getLog=()=>load(LOG_KEY,[]);
const setLog=v=>save(LOG_KEY,v);

/* Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Î¼Îµ fallback ÏƒÏ„Î± DEFAULT_NAMES + default Ï„Î¹Î¼Î­Ï‚ */
const settings = () => {
const base = {
names: DEFAULT_NAMES,
webhook: "",
shiftStart: "08:00",
grace: 5
};
const stored = load(SET_KEY, null);
if (!stored || typeof stored !== 'object') return base;

return {
names: Array.isArray(stored.names) && stored.names.length ? stored.names : DEFAULT_NAMES,
webhook: (stored.webhook || ""),
shiftStart: stored.shiftStart || "08:00",
grace: (typeof stored.grace === "number" ? stored.grace : 5)
};
};
const saveSettingsObj=o=>save(SET_KEY,o);

/* 24Ï‰ÏÎ· ÏÏÎ± Î³Î¹Î± ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ· */
function toParts(iso){
const d=new Date(iso);
const date=d.toLocaleDateString('el-GR');
const time=d.toLocaleTimeString('el-GR',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
return {date,time};
}
const makeEntry=(name,action,note)=>{const iso=new Date().toISOString();const p=toParts(iso);return{id:Math.random().toString(36).slice(2),name,action,iso,date:p.date,time:p.time,note:note||''}};

/* ====== PIN lock (auto-lock 2') ====== */
let adminUnlockedUntil=0; const autoLockMs=2*60*1000;
const now=()=>Date.now(), isAdminUnlocked=()=>now()<adminUnlockedUntil, touchAdmin=()=>adminUnlockedUntil=now()+autoLockMs;
async function sha256(s){const e=new TextEncoder().encode(s);const b=await crypto.subtle.digest('SHA-256',e);return Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,'0')).join('')}
function showPinModal(setMode=false){return new Promise(res=>{const m=pinModal,i=pinInput,msg=pinMsg,t=pinTitle;t.textContent=setMode?'ÎŸÏÎ¯ÏƒÏ„Îµ Î½Î­Î¿ PIN':'ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î®';msg.textContent='';i.value='';m.style.display='flex';function done(v){m.style.display='none';res(v)};pinCancel.onclick=()=>done(null);pinOk.onclick=()=>done(i.value.trim());i.onkeydown=e=>{if(e.key==='Enter')pinOk.click()};i.focus()})}
async function requireAdmin(){
if(isAdminUnlocked()){touchAdmin();return true}
let saved=localStorage.getItem(ADMIN_KEY);
if(!saved){const first=await showPinModal(true); if(!first)return false; const h=await sha256(first); localStorage.setItem(ADMIN_KEY,h); touchAdmin(); return true}
const pin=await showPinModal(false); if(!pin)return false;
const ok=(await sha256(pin))===saved; if(ok){touchAdmin();return true}
pinMsg.textContent='Î›Î¬Î¸Î¿Ï‚ PIN'; pinMsg.style.color='#b42318'; return false;
}
lockBtn.addEventListener('click',()=>{adminUnlockedUntil=0});
['click','touchstart','keydown','mousemove'].forEach(evt=>addEventListener(evt,()=>{if(isAdminUnlocked())touchAdmin()},{passive:true}));

/* ====== Tabs (guarded) ====== */
$$('.tabbtn').forEach(btn=>{
btn.addEventListener('click', async ()=>{
const needAdmin=btn.classList.contains('guard');
if(needAdmin && !(await requireAdmin())) return;
$$('.tabbtn').forEach(x=>x.classList.remove('active')); btn.classList.add('active');
$$('.tab').forEach(x=>x.classList.remove('active')); const tab=$('#tab-'+btn.dataset.tab); if(tab) tab.classList.add('active');
if(btn.dataset.tab==='history') renderLog();
});
});

/* ====== Init employees + settings UI ====== */
function refreshEmployees(){
const s=settings(); const sel=$("#employee"); sel.innerHTML='';
s.names.forEach(n=>{const o=document.createElement('option');o.value=o.textContent=n;sel.appendChild(o)});
$("#names").value=s.names.join('\n');
$("#webhook").value=s.webhook||'';
$("#shiftStart").value=s.shiftStart||'08:00';
$("#grace").value=s.grace??5;
}
$("#add").addEventListener('click', ()=>{
const name=$("#newname").value.trim(); if(!name) return;
const s=settings(); if(!s.names.includes(name)) s.names.push(name); saveSettingsObj(s);
$("#newname").value=''; refreshEmployees(); $("#statusRow").textContent=`Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ Î¿/Î· ${name}.`;
});
$("#saveSettings").addEventListener('click', ()=>{
const s=settings();
s.names=$("#names").value.split('\n').map(x=>x.trim()).filter(Boolean);
s.webhook=$("#webhook").value.trim();
s.shiftStart=$("#shiftStart").value.trim()||'08:00';
s.grace=Math.max(0, parseInt($("#grace").value||'5',10));
saveSettingsObj(s); $("#saveMsg").textContent='Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎ±Î½.'; refreshEmployees(); setTimeout(()=>$("#saveMsg").textContent='',1500);
});

/* ====== Punch logic + cloud sync on OUT ====== */
function lastActionFor(name){const log=getLog().filter(x=>x.name===name).sort((a,b)=>b.iso.localeCompare(a.iso));return log[0]?.action||null}

/* Î Î±Î¯ÏÎ½ÎµÎ¹ Ï„Î¿ URL Î±Ï€ÏŒ Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Î® Î±Ï€ÏŒ Default */
function getWebhookUrl(){
const u=(settings().webhook||'').trim();
if(u && u.startsWith('http')) return u;
return (DEFAULT_WEB_APP_URL||'').trim();
}

/* Î‘ÏƒÏ†Î±Î»Î®Ï‚ Ï€ÏÎ¿ÏƒÎ¸Î®ÎºÎ· token */
function withToken(url, token){
if(!token) return url;
const sep = url.includes('?') ? '&' : '?';
return url + sep + 'token=' + encodeURIComponent(token);
}

async function sendWebhookIfAny(payload){
let base = getWebhookUrl();
if(!base){ document.getElementById('statusRow').textContent = 'Cloud: no URL set'; return; }

const url = withToken(base, SECRET_TOKEN);
try {
const ctrl = new AbortController();
const t = setTimeout(()=>ctrl.abort(), 10000); // 10s timeout
const res = await fetch(url, {
method: 'POST',
headers: { 'Content-Type': 'text/plain' }, // Î±Ï€Î¿Ï†ÎµÏÎ³Î¿Ï…Î¼Îµ preflight/CORS
body: JSON.stringify(payload),
cache: 'no-store',
redirect: 'follow',
signal: ctrl.signal
});
clearTimeout(t);

const txt = await res.text().catch(()=> '');
const ok = res.ok && (txt || '').includes('"ok":true');
document.getElementById('statusRow').textContent =
ok ? `Cloud: OK ${res.status}` : `Cloud: ERR ${res.status} ${txt || ''}`;
} catch (err) {
document.getElementById('statusRow').textContent = 'Cloud error: ' + (err?.message || err);
}
}

const minutesBetween=(a,b)=>Math.max(0,Math.round((new Date(b)-new Date(a))/60000));

function updateLastStatus(name){
const la=lastActionFor(name);
$("#lastRow").textContent = la ? `Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿ Ï‡Ï„ÏÏ€Î·Î¼Î±: ${la}` : 'Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿ Ï‡Ï„ÏÏ€Î·Î¼Î±: â€”';
}

function punch(action){
const name = $("#employee").value;
if (!name || name === 'â€”') {
$("#statusRow").textContent = 'Î”Î¹Î¬Î»ÎµÎ¾Îµ ÎµÏÎ³Î±Î¶ÏŒÎ¼ÎµÎ½Î¿.';
return;
}

const last = lastActionFor(name);
const note = $("#note").value.trim();

// ğŸš« ÎœÎ Î›ÎŸÎš Î”Î™Î Î›ÎŸ IN
if (action === 'IN' && last === 'IN') {
$("#statusRow").textContent = `${name}: ÎˆÏ‡ÎµÎ¹Ï‚ Î®Î´Î· ÎºÎ¬Î½ÎµÎ¹ IN. ÎšÎ¬Î½Îµ Ï€ÏÏÏ„Î± OUT.`;
updateLastStatus(name);
$("#note").value = '';
return;
}

// ğŸš« ÎœÎ Î›ÎŸÎš Î”Î™Î Î›ÎŸ OUT / OUT Î§Î©Î¡Î™Î£ Î‘ÎÎŸÎ™Î§Î¤Î— Î’Î‘Î¡Î”Î™Î‘
if (action === 'OUT' && last !== 'IN') {
$("#statusRow").textContent = `${name}: Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎµÎ½ÎµÏÎ³Î® Î²Î¬ÏÎ´Î¹Î± Î³Î¹Î± OUT.`;
updateLastStatus(name);
$("#note").value = '';
return;
}

// âœ… Î‘Î½ Ï€ÎµÏÎ¬ÏƒÎµÎ¹ Ï„Î¿Ï…Ï‚ ÎµÎ»Î­Î³Ï‡Î¿Ï…Ï‚, ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ¿ÏÎ¼Îµ Ï„Î¿ Ï‡Ï„ÏÏ€Î·Î¼Î± ÏƒÏ„Î¿ local log
const entry = makeEntry(name, action, note);
const log = getLog();
log.push(entry);
setLog(log);

$("#statusRow").textContent =
`${name} â€¢ ${action} â€¢ ${entry.date} ${entry.time}${note ? ` â€¢ ${note}` : ''}`;
updateLastStatus(name);

// âœ… Î£Ï„Î­Î»Î½Î¿Ï…Î¼Îµ ÏƒÏ„Î¿ cloud ÎœÎŸÎÎŸ ÏƒÏ„Î¿ OUT, ÎºÎ±Î¹ ÎœÎŸÎÎŸ ÏŒÏ„Î±Î½ Ï…Ï€Î®ÏÏ‡Îµ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿ IN
if (action === 'OUT') {
const rows = log
.filter(x => x.name === name)
.sort((a, b) => a.iso.localeCompare(b.iso));

const lastIn = [...rows].reverse().find(x => x.action === 'IN');
if (lastIn) {
const mins = minutesBetween(lastIn.iso, entry.iso);
sendWebhookIfAny({
type: 'session',
name,
start: lastIn.iso,
end: entry.iso,
minutes: mins,
date: entry.date,
note
});
}
}

$("#note").value = '';
}

/* ====== History ====== */
function renderLog(){
const q=$("#search").value?.trim().toLowerCase()||'';
const tbody=$("#logTable tbody"); if(!tbody) return; tbody.innerHTML='';
const rows=[...getLog()].sort((a,b)=>b.iso.localeCompare(a.iso));
rows.forEach(r=>{
const hay=(r.name+' '+r.date+' '+r.time+' '+(r.note||'')).toLowerCase();
if(q && !hay.includes(q)) return;
const tr=document.createElement('tr');
tr.innerHTML=`<td>${r.name}</td><td>${r.action}</td><td>${r.date}</td><td>${r.time}</td><td>${r.note||''}</td>`;
tbody.appendChild(tr);
});
}
$("#search")?.addEventListener('input', renderLog);
$("#exportBtn")?.addEventListener('click', ()=>{
const rows=[["name","action","iso","date","time","note"], ...getLog().map(r=>[r.name,r.action,r.iso,r.date,r.time,r.note||""])];
const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='attendance.csv'; a.click();
});
$("#downloadJson")?.addEventListener('click', ()=>{
const blob=new Blob([JSON.stringify(getLog(),null,2)],{type:'application/json'});
const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='attendance.json'; a.click();
});
$("#clear")?.addEventListener('click', async ()=>{
if(!(await requireAdmin())) return;
if(!confirm('Î£Î¯Î³Î¿Ï…ÏÎ± Î´Î¹Î±Î³ÏÎ±Ï†Î® ÏŒÎ»Ï‰Î½;')) return;
setLog([]); renderLog();
});

/* ====== Reports ====== */
$("#calc-month")?.addEventListener('click', ()=>{
const month=$("#rep-month").value; if(!month){ alert('Î”Î¹Î¬Î»ÎµÎ¾Îµ Î¼Î®Î½Î±.'); return; }
const [y,m]=month.split('-').map(Number);
const start=new Date(y,m-1,1), end=new Date(y,m,1);
const rows=getLog().filter(r=>{const d=new Date(r.iso); return d>=start && d<end;}).sort((a,b)=>a.iso.localeCompare(b.iso));

const map=new Map(); // key: name|YYYY-MM-DD
for(const r of rows){ const d=new Date(r.iso), key=`${r.name}|${d.toISOString().slice(0,10)}`; if(!map.has(key)) map.set(key,[]); map.get(key).push(r); }

const out=[];
for(const [key, arr] of map){
arr.sort((a,b)=>a.iso.localeCompare(b.iso));
let minutes=0;
for(let i=0;i<arr.length;i++){
if(arr[i].action==='IN'){
const outIdx=arr.slice(i+1).findIndex(x=>x.action==='OUT');
if(outIdx>-1){ const outRow=arr[i+1+outIdx]; minutes+=minutesBetween(arr[i].iso,outRow.iso); i=i+outIdx; }
}
}
const [name, day]=key.split('|');
const dateParts=(new Date(day)).toLocaleDateString('el-GR');
const weekday=(new Date(day)).toLocaleDateString('el-GR',{weekday:'long'});
const status = minutes>0 ? 'OK' : 'Î‘Ï€Î¿Ï…ÏƒÎ¯Î±/Î‘Î½Î¿Î»Î¿ÎºÎ»Î®ÏÏ‰Ï„Î¿';
out.push({name, weekday, date:dateParts, minutes, status});
}

const tbody=$("#reportTable tbody"); tbody.innerHTML='';
out.sort((a,b)=>a.name.localeCompare(b.name)||a.date.localeCompare(b.date))
.forEach(r=>{
const tr=document.createElement('tr');
tr.innerHTML=`<td>${r.name}</td><td>${r.weekday}</td><td>${r.date}</td>
<td>${Math.floor(r.minutes/60)}:${String(r.minutes%60).padStart(2,'0')}</td>
<td>${r.status}</td>`;
tbody.appendChild(tr);
});
});

/* ====== Bootstrap ====== */
(function init(){
if('serviceWorker' in navigator){
navigator.serviceWorker.register('./sw.js').catch(()=>{});
}
const s=settings();
if(!Array.isArray(s.names) || !s.names.length){
saveSettingsObj({names: DEFAULT_NAMES, webhook:"", shiftStart:"08:00", grace:5});
}
refreshEmployees();
updateLastStatus($("#employee").value);
})();
</script>
</body>
</html>
